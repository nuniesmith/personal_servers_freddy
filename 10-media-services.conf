# ================================================
# MEDIA SERVICES - CLEAN & OPTIMIZED - FIXED
# ================================================
# Updated to use standardized includes and eliminate ALL duplication
# FIXED: Removed ssl_combined log format references

# ================================================
# RATE LIMITING ZONES
# ================================================
limit_req_zone $binary_remote_addr zone=media_service:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=media_upload:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=media_streaming:10m rate=50r/s;

# ================================================
# EMBY - MEDIA STREAMING SERVER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name emby.7gram.xyz;
    
    # Docker DNS resolver for dynamic hostname resolution
    resolver 127.0.0.11 valid=30s;
    
    # ================================================
    # INCLUDE SHARED CONFIGURATIONS (NO DUPLICATION!)
    # ================================================
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # ================================================
    # ERROR LOCATION BLOCKS (MUST BE DIRECT)
    # ================================================
    
    # Error page locations (serve existing static files)
    location = /errors/404.html {
        internal;
        root /usr/share/nginx/html;
    }

    location = /errors/500.html {
        internal;
        root /usr/share/nginx/html;
    }

    location = /errors/502.html {
        internal;
        root /usr/share/nginx/html;
    }

    location = /errors/503.html {
        internal;
        root /usr/share/nginx/html;
    }

    location = /errors/504.html {
        internal;
        root /usr/share/nginx/html;
    }

    location @error401 {
        return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri;
    }

    location @error403 {
        add_header Content-Type "text/html; charset=utf-8" always;
        return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>';
    }
    
    # ================================================
    # ENHANCED LOGGING (FIXED - NO SSL_COMBINED)
    # ================================================
    access_log /var/log/nginx/emby-access.log main if=$should_log;
    error_log /var/log/nginx/emby-error.log;
    
    # ================================================
    # AUTH ENDPOINT (REQUIRED FOR PROTECTED SERVICES)
    # ================================================
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    # ================================================
    # MAIN APPLICATION PROXY
    # ================================================
    location / {
        # Rate limiting for media service
        limit_req zone=media_service burst=50 nodelay;
        
        # Include authentication
        include /etc/nginx/includes/auth.conf;
        
        # Proxy to Emby server
        set $upstream http://100.86.22.59:8096;
        proxy_pass $upstream;
        
        # Include media-optimized proxy parameters
        include /etc/nginx/includes/media_proxy_params.conf;
        
        # Media-specific optimizations
        client_max_body_size 0;
        
        # Enhanced timeout for streaming
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}

# ================================================
# JELLYFIN - MEDIA STREAMING SERVER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name jellyfin.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    # Include all shared configurations
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks
    location = /errors/404.html {
        internal;
        root /usr/share/nginx/html;
    }
    location = /errors/500.html {
        internal;
        root /usr/share/nginx/html;
    }
    location = /errors/502.html {
        internal;
        root /usr/share/nginx/html;
    }
    location = /errors/503.html {
        internal;
        root /usr/share/nginx/html;
    }
    location = /errors/504.html {
        internal;
        root /usr/share/nginx/html;
    }
    location @error401 {
        return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri;
    }
    location @error403 {
        add_header Content-Type "text/html; charset=utf-8" always;
        return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>';
    }
    
    # Enhanced logging (FIXED)
    access_log /var/log/nginx/jellyfin-access.log main if=$should_log;
    error_log /var/log/nginx/jellyfin-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=50 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:8099;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/media_proxy_params.conf;
        
        client_max_body_size 0;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}

# ================================================
# PLEX - MEDIA STREAMING SERVER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name plex.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    # Include all shared configurations
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (properly closed)
    location = /errors/404.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/500.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/502.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/503.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/504.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location @error401 {
        return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri;
    }
    
    location @error403 {
        add_header Content-Type "text/html; charset=utf-8" always;
        return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>';
    }
    
    access_log /var/log/nginx/plex-access.log main if=$should_log;
    error_log /var/log/nginx/plex-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=50 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:32400;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/media_proxy_params.conf;
        
        client_max_body_size 0;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}

# ================================================
# AUDIOBOOKSHELF - AUDIOBOOK SERVER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name abs.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (properly closed)
    location = /errors/404.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/500.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/502.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/503.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/504.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location @error401 {
        return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri;
    }
    
    location @error403 {
        add_header Content-Type "text/html; charset=utf-8" always;
        return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>';
    }
    
    access_log /var/log/nginx/abs-access.log main if=$should_log;
    error_log /var/log/nginx/abs-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=30 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:80;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        client_max_body_size 100M;
    }
}

# ================================================
# CALIBRE - EBOOK SERVER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name calibre.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (compact)
    location = /errors/404.html { internal; root /usr/share/nginx/html; }
    location = /errors/500.html { internal; root /usr/share/nginx/html; }
    location = /errors/502.html { internal; root /usr/share/nginx/html; }
    location = /errors/503.html { internal; root /usr/share/nginx/html; }
    location = /errors/504.html { internal; root /usr/share/nginx/html; }
    location @error401 { return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri; }
    location @error403 { add_header Content-Type "text/html; charset=utf-8" always; return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>'; }
    
    access_log /var/log/nginx/calibre-access.log main if=$should_log;
    error_log /var/log/nginx/calibre-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=30 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:8081;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        client_max_body_size 100M;
    }
}

# ================================================
# CALIBRE WEB - WEB INTERFACE FOR CALIBRE
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name calibreweb.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (compact)
    location = /errors/404.html { internal; root /usr/share/nginx/html; }
    location = /errors/500.html { internal; root /usr/share/nginx/html; }
    location = /errors/502.html { internal; root /usr/share/nginx/html; }
    location = /errors/503.html { internal; root /usr/share/nginx/html; }
    location = /errors/504.html { internal; root /usr/share/nginx/html; }
    location @error401 { return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri; }
    location @error403 { add_header Content-Type "text/html; charset=utf-8" always; return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>'; }
    
    access_log /var/log/nginx/calibreweb-access.log main if=$should_log;
    error_log /var/log/nginx/calibreweb-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=30 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:8083;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        client_max_body_size 100M;
    }
}

# ================================================
# YOUTUBE-DL - VIDEO DOWNLOADER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name youtube.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (compact)
    location = /errors/404.html { internal; root /usr/share/nginx/html; }
    location = /errors/500.html { internal; root /usr/share/nginx/html; }
    location = /errors/502.html { internal; root /usr/share/nginx/html; }
    location = /errors/503.html { internal; root /usr/share/nginx/html; }
    location = /errors/504.html { internal; root /usr/share/nginx/html; }
    location @error401 { return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri; }
    location @error403 { add_header Content-Type "text/html; charset=utf-8" always; return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>'; }
    
    access_log /var/log/nginx/youtube-access.log main if=$should_log;
    error_log /var/log/nginx/youtube-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_upload burst=20 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:17442;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        # Large downloads
        client_max_body_size 500M;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}

# ================================================
# MEALIE - RECIPE MANAGER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name mealie.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (compact)
    location = /errors/404.html { internal; root /usr/share/nginx/html; }
    location = /errors/500.html { internal; root /usr/share/nginx/html; }
    location = /errors/502.html { internal; root /usr/share/nginx/html; }
    location = /errors/503.html { internal; root /usr/share/nginx/html; }
    location = /errors/504.html { internal; root /usr/share/nginx/html; }
    location @error401 { return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri; }
    location @error403 { add_header Content-Type "text/html; charset=utf-8" always; return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>'; }
    
    access_log /var/log/nginx/mealie-access.log main if=$should_log;
    error_log /var/log/nginx/mealie-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=30 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:9000;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        client_max_body_size 100M;
    }
}

# ================================================
# GROCY - GROCERY MANAGEMENT
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name grocy.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (compact)
    location = /errors/404.html { internal; root /usr/share/nginx/html; }
    location = /errors/500.html { internal; root /usr/share/nginx/html; }
    location = /errors/502.html { internal; root /usr/share/nginx/html; }
    location = /errors/503.html { internal; root /usr/share/nginx/html; }
    location = /errors/504.html { internal; root /usr/share/nginx/html; }
    location @error401 { return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri; }
    location @error403 { add_header Content-Type "text/html; charset=utf-8" always; return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>'; }
    
    access_log /var/log/nginx/grocy-access.log main if=$should_log;
    error_log /var/log/nginx/grocy-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=30 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:80;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        client_max_body_size 50M;
    }
}

# ================================================
# WIKI - DOCUMENTATION
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name wiki.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (compact)
    location = /errors/404.html { internal; root /usr/share/nginx/html; }
    location = /errors/500.html { internal; root /usr/share/nginx/html; }
    location = /errors/502.html { internal; root /usr/share/nginx/html; }
    location = /errors/503.html { internal; root /usr/share/nginx/html; }
    location = /errors/504.html { internal; root /usr/share/nginx/html; }
    location @error401 { return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri; }
    location @error403 { add_header Content-Type "text/html; charset=utf-8" always; return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>'; }
    
    access_log /var/log/nginx/wiki-access.log main if=$should_log;
    error_log /var/log/nginx/wiki-error.log;
    
    # Auth endpoint
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=30 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:8080;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        client_max_body_size 100M;
    }
}

# ================================================
# NEXTCLOUD - CLOUD STORAGE (NO AUTH - USES INTERNAL)
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name nc.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (compact)
    location = /errors/404.html { internal; root /usr/share/nginx/html; }
    location = /errors/500.html { internal; root /usr/share/nginx/html; }
    location = /errors/502.html { internal; root /usr/share/nginx/html; }
    location = /errors/503.html { internal; root /usr/share/nginx/html; }
    location = /errors/504.html { internal; root /usr/share/nginx/html; }
    location @error401 { return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri; }
    location @error403 { add_header Content-Type "text/html; charset=utf-8" always; return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>'; }
    
    access_log /var/log/nginx/nextcloud-access.log main if=$should_log;
    error_log /var/log/nginx/nextcloud-error.log;
    
    # ================================================
    # NO AUTHELIA - NEXTCLOUD HANDLES ITS OWN AUTH
    # ================================================
    
    location / {
        limit_req zone=media_service burst=50 nodelay;
        
        set $upstream http://100.86.22.59:8081;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/proxy_params.conf;
        
        # Nextcloud-specific optimizations
        client_max_body_size 10G;
        
        # WebDAV support
        proxy_set_header X-Forwarded-Server $host;
    }
}