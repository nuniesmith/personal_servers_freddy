# ================================================
# MEDIA SERVICES - SIMPLE & WORKING VERSION
# ================================================
# Start with just Emby to ensure syntax is correct

# ================================================
# RATE LIMITING ZONES
# ================================================
limit_req_zone $binary_remote_addr zone=media_service:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=media_upload:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=media_streaming:10m rate=50r/s;

# ================================================
# EMBY - MEDIA STREAMING SERVER
# ================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name emby.7gram.xyz;
    
    resolver 127.0.0.11 valid=30s;
    
    include /etc/nginx/conf.d/00-ssl-shared.conf;
    include /etc/nginx/includes/cors_health.conf;
    include /etc/nginx/includes/error_pages.conf;
    include /etc/nginx/includes/health_locations.conf;
    
    # Error location blocks (properly formatted)
    location = /errors/404.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/500.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/502.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/503.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location = /errors/504.html {
        internal;
        root /usr/share/nginx/html;
    }
    
    location @error401 {
        return 302 https://auth.7gram.xyz/?rd=$scheme://$http_host$request_uri;
    }
    
    location @error403 {
        add_header Content-Type "text/html; charset=utf-8" always;
        return 403 '<!DOCTYPE html><html><head><title>403 - Access Forbidden</title></head><body><h1>403 - Access Forbidden</h1><p>You do not have permission to access this resource.</p><a href="https://auth.7gram.xyz">Login</a></body></html>';
    }
    
    access_log /var/log/nginx/emby-access.log main if=$should_log;
    error_log /var/log/nginx/emby-error.log;
    
    location = /auth {
        internal;
        set $upstream_authelia http://authelia:9091;
        proxy_pass $upstream_authelia/api/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_set_header Accept-Encoding "";
        proxy_connect_timeout 5s;
        proxy_intercept_errors off;
        error_page 301 302 303 307 308 = @auth_redirect;
    }
    
    location @auth_redirect {
        internal;
        return 401;
    }
    
    location / {
        limit_req zone=media_service burst=50 nodelay;
        include /etc/nginx/includes/auth.conf;
        
        set $upstream http://100.86.22.59:8096;
        proxy_pass $upstream;
        
        include /etc/nginx/includes/media_proxy_params.conf;
        
        client_max_body_size 0;
    }
}